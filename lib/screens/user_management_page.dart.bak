import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:cloud_functions/cloud_functions.dart';
import 'dart:async';
import 'package:shared_preferences/shared_preferences.dart';

class UserManagementPage extends StatefulWidget {
  const UserManagementPage({Key? key}) : super(key: key);

  @override
  State<UserManagementPage> createState() => _UserManagementPageState();
}

class _UserManagementPageState extends State<UserManagementPage> 
    with SingleTickerProviderStateMixin {
  late TabController _tabController;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 4, vsync: this);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey[50],
      appBar: AppBar(
        title: Text(
          'User Management',
          style: GoogleFonts.montserrat(
            fontWeight: FontWeight.w600,
            color: Colors.white,
          ),
        ),
        backgroundColor: const Color(0xFF1A1E3F),
        elevation: 0,
        bottom: TabBar(
          controller: _tabController,
          labelColor: Colors.white,
          unselectedLabelColor: Colors.white70,
          indicatorColor: const Color(0xFFD62828),
          labelStyle: GoogleFonts.montserrat(fontWeight: FontWeight.w600),
          tabs: const [
              Tab(text: 'All Users'),
              Tab(text: 'Students'),
              Tab(text: 'Teachers'),
              Tab(text: 'School Admins'),
          ],
        ),
      ),
      body: TabBarView(
        controller: _tabController,
          children: const [
            AllUsersTab(),
            StudentManagementTab(),
            TeacherManagementTab(),
            SchoolAdminManagementTab(),
          ],
      ),
    );
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }
}

class StudentManagementTab extends StatefulWidget {
  const StudentManagementTab({Key? key}) : super(key: key);

  @override
  State<StudentManagementTab> createState() => _StudentManagementTabState();
}

class _StudentManagementTabState extends State<StudentManagementTab> {
  final TextEditingController _searchController = TextEditingController();
  final FirebaseFirestore _db = FirebaseFirestore.instance;
  final FirebaseFunctions _functions = FirebaseFunctions.instance;

  List<QueryDocumentSnapshot> _docs = [];
  final Set<String> _selected = {};

  // pagination
  DocumentSnapshot? _lastDoc;
  bool _hasMore = true;
  bool _loadingPage = false;
  int _pageSize = 20;
  final List<DocumentSnapshot?> _pageStack = [];

  // search / filters
  String _searchQuery = '';

  // prefs
  static const _prefPageSize = 'admin_students_pageSize';

  @override
  void initState() {
    super.initState();
    _loadPrefs().then((_) => _fetchPage(reset: true));
    _searchController.addListener(() {
      final q = _searchController.text.trim();
      if (q != _searchQuery) {
        _searchQuery = q;
        _fetchPage(reset: true);
      }
    });
  }

  Future<void> _loadPrefs() async {
    try {
      final sp = await SharedPreferences.getInstance();
      final p = sp.getInt(_prefPageSize) ?? 20;
      setState(() => _pageSize = p);
    } catch (e) {
      // ignore
    }
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  Future<void> _deleteUsers(List<String> uids) async {
    final ok = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('Confirm delete'),
        content: Text('Are you sure you want to delete ${uids.length} student(s)? This will remove their Firestore profile and aggregates. Deleting Auth account requires server-side action.'),
        actions: [
          TextButton(onPressed: () => Navigator.of(ctx).pop(false), child: const Text('Cancel')),
          ElevatedButton(onPressed: () => Navigator.of(ctx).pop(true), child: const Text('Delete')),
        ],
      ),
    );

    if (ok != true) return;

    try {
      final HttpsCallable func = _functions.httpsCallable('adminDeleteUser');
      final resp = await func.call(<String, dynamic>{'uids': uids});
      final data = resp.data as Map<String, dynamic>?;
      int succ = 0;
      if (data != null && data['results'] is Map) {
        final results = Map<String, dynamic>.from(data['results']);
        for (final e in results.entries) if (e.value['success'] == true) succ++;
      }
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Delete requested. Success: $succ of ${uids.length}')));
    } catch (e) {
      final batch = _db.batch();
      for (final uid in uids) {
        batch.delete(_db.collection('users').doc(uid));
        batch.delete(_db.collection('aggregates').doc('user').collection(uid).doc('stats'));
      }
      await batch.commit();
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Firestore profiles deleted. Auth accounts may still exist.')));
    }

    setState(() => _selected.clear());
  }

  Future<void> _sendMessageToUsers(List<String> uids) async {
    final result = await showDialog<Map<String, String>?>(
      context: context,
      builder: (ctx) {
        final titleCtrl = TextEditingController();
        final bodyCtrl = TextEditingController();
        return AlertDialog(
          title: const Text('Send message'),
          content: SizedBox(
            width: 420,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                TextField(controller: titleCtrl, decoration: const InputDecoration(labelText: 'Title')),
                const SizedBox(height: 8),
                TextField(controller: bodyCtrl, decoration: const InputDecoration(labelText: 'Message'), maxLines: 4),
              ],
            ),
          ),
          actions: [
            TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')),
            ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'title': titleCtrl.text, 'body': bodyCtrl.text}), child: const Text('Send')),
          ],
        );
      },
    );

    if (result == null) return;
    final title = result['title'] ?? '';
    final body = result['body'] ?? '';
    final batch = _db.batch();
    final now = FieldValue.serverTimestamp();
    for (final uid in uids) {
      final nref = _db.collection('notifications').doc();
      batch.set(nref, {
        'userId': uid,
        'title': title,
        'message': body,
        'type': 'admin_message',
        'read': false,
        'timestamp': now,
      });
    }
    await batch.commit();

    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Message queued for selected students.')));
  }

  Future<void> _createUser() async {
    final data = await showDialog<Map<String, String>?>(
      context: context,
      builder: (ctx) {
        final email = TextEditingController();
        final password = TextEditingController();
        final first = TextEditingController();
        final last = TextEditingController();
        return AlertDialog(
          title: const Text('Create student'),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                TextField(controller: email, decoration: const InputDecoration(labelText: 'Email')),
                const SizedBox(height: 8),
                TextField(controller: password, decoration: const InputDecoration(labelText: 'Password')),
                const SizedBox(height: 8),
                Row(children: [Expanded(child: TextField(controller: first, decoration: const InputDecoration(labelText: 'First name'))), const SizedBox(width: 8), Expanded(child: TextField(controller: last, decoration: const InputDecoration(labelText: 'Last name')))]),
              ],
            ),
          ),
          actions: [TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')), ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'email': email.text.trim(), 'password': password.text, 'first': first.text.trim(), 'last': last.text.trim(), 'role': 'student'}), child: const Text('Create'))],
        );
      },
    );

    if (data == null) return;

    try {
      final HttpsCallable func = _functions.httpsCallable('adminCreateUser');
      final resp = await func.call(<String, dynamic>{
        'email': data['email'],
        'password': data['password'],
        'firstName': data['first'],
        'lastName': data['last'],
        'role': 'student',
      });
      final res = resp.data as Map<String, dynamic>?;
      if (res != null && res['uid'] != null) {
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Student created successfully.')));
        _fetchPage(reset: true);
        return;
      }
    } catch (e) {
      // ignore
    }

    final userRef = _db.collection('users').doc();
    await userRef.set({
      'email': data['email'],
      'firstName': data['first'],
      'lastName': data['last'],
      'displayName': '${data['first']} ${data['last']}',
      'role': 'student',
      'createdAt': FieldValue.serverTimestamp(),
    });
    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Created student document. To create an Auth account, deploy adminCreateUser function.')));
    _fetchPage(reset: true);
  }

  Future<void> _sendMessageDialog() async {
    final result = await showDialog<Map<String, dynamic>?>(
      context: context,
      builder: (ctx) {
        String recipient = 'all';
        final titleCtrl = TextEditingController();
        final bodyCtrl = TextEditingController();
        return StatefulBuilder(
          builder: (ctx, setState) => AlertDialog(
            title: const Text('Send Message'),
            content: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  DropdownButtonFormField<String>(
                    value: recipient,
                    items: [
                      const DropdownMenuItem(value: 'all', child: Text('All Users')),
                      const DropdownMenuItem(value: 'students', child: Text('Students')),
                      const DropdownMenuItem(value: 'teachers', child: Text('Teachers')),
                      const DropdownMenuItem(value: 'school_admins', child: Text('School Admins')),
                      if (_selected.isNotEmpty) const DropdownMenuItem(value: 'selected', child: Text('Selected Users')),
                    ],
                    onChanged: (v) => setState(() => recipient = v ?? 'all'),
                    decoration: const InputDecoration(labelText: 'Recipients'),
                  ),
                  const SizedBox(height: 8),
                  TextField(controller: titleCtrl, decoration: const InputDecoration(labelText: 'Title')),
                  const SizedBox(height: 8),
                  TextField(controller: bodyCtrl, decoration: const InputDecoration(labelText: 'Message'), maxLines: 4),
                ],
              ),
            ),
            actions: [
              TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')),
              ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'recipient': recipient, 'title': titleCtrl.text, 'body': bodyCtrl.text}), child: const Text('Send')),
            ],
          ),
        );
      },
    );

    if (result == null) return;

    final recipient = result['recipient'];
    final title = result['title'] ?? '';
    final body = result['body'] ?? '';
    List<String> uids = [];
    if (recipient == 'selected') {
      uids = _selected.toList();
    } else {
      // fetch all uids for the role
      Query q = _db.collection('users');
      if (recipient != 'all') {
        String role = recipient == 'students' ? 'student' : recipient == 'teachers' ? 'teacher' : 'school_admin';
        q = q.where('role', isEqualTo: role);
      }
      final snap = await q.get();
      uids = snap.docs.map((d) => d.id).toList();
    }

    if (uids.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('No users to send to.')));
      return;
    }

    final batch = _db.batch();
    final now = FieldValue.serverTimestamp();
    for (final uid in uids) {
      final nref = _db.collection('notifications').doc();
      batch.set(nref, {
        'userId': uid,
        'title': title,
        'message': body,
        'type': 'admin_message',
        'read': false,
        'timestamp': now,
      });
    }
    await batch.commit();
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Message sent to ${uids.length} users.')));
  }

  Future<void> _fetchPage({bool reset = false}) async {
    if (_loadingPage) return;
    setState(() => _loadingPage = true);

    if (reset) {
      _docs = [];
      _lastDoc = null;
      _hasMore = true;
      _pageStack.clear();
    }

    if (!_hasMore) {
      setState(() => _loadingPage = false);
      return;
    }

    try {
      Query q = _db.collection('users').where('role', isEqualTo: 'student').orderBy('createdAt', descending: true);

      final sq = _searchQuery.trim();
      if (sq.isNotEmpty) {
        if (sq.contains('@')) {
          q = q.where('email', isGreaterThanOrEqualTo: sq).where('email', isLessThanOrEqualTo: sq + '\uf8ff');
        } else {
          q = q.where('displayName', isGreaterThanOrEqualTo: sq).where('displayName', isLessThanOrEqualTo: sq + '\uf8ff');
        }
      }

      q = q.limit(_pageSize);
      if (_lastDoc != null) q = q.startAfterDocument(_lastDoc!);

      final snap = await q.get();
      final docs = snap.docs;
      if (docs.isNotEmpty) {
        _pageStack.add(_lastDoc);
        _lastDoc = docs.last;
        _docs.addAll(docs);
      }

      if (docs.length < _pageSize) _hasMore = false;
    } catch (e) {
      debugPrint('fetchPage error: $e');
    } finally {
      setState(() => _loadingPage = false);
    }
  }

  Future<void> _prevPage() async {
    if (_pageStack.isEmpty) return;
    final prevLast = _pageStack.length >= 1 ? _pageStack[_pageStack.length - 1] : null;
    _pageStack.removeLast();
    _lastDoc = prevLast as DocumentSnapshot?;
    _docs = [];
    _hasMore = true;
    await _fetchPage(reset: true);
  }

  void _showUserDetailDialog(Map<String, dynamic> userData) {
    final uid = userData['uid'] ?? '';
    final avatar = userData['avatar'] as String?;
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        insetPadding: const EdgeInsets.symmetric(horizontal: 40, vertical: 24),
        child: ConstrainedBox(
          constraints: BoxConstraints(
            maxWidth: 600,
            maxHeight: MediaQuery.of(context).size.height * 0.8,
          ),
          child: Column(
            children: [
              Container(
                padding: const EdgeInsets.all(20),
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Color(0xFFD62828), Color(0xFFB71C1C)],
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                  ),
                  borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
                ),
                child: Row(
                  children: [
                    CircleAvatar(
                      radius: 32,
                      backgroundColor: Colors.white,
                      backgroundImage: avatar?.isNotEmpty == true ? NetworkImage(avatar!) : null,
                      child: avatar == null
                          ? Text(
                              ((userData['displayName'] ?? userData['firstName'] ?? '?') as String)[0].toUpperCase(), 
                              style: GoogleFonts.montserrat(fontSize: 20, color: const Color(0xFFD62828), fontWeight: FontWeight.bold)
                            )
                          : null,
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            userData['displayName'] ?? userData['firstName'] ?? '-', 
                            style: GoogleFonts.playfairDisplay(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white)
                          ),
                          const SizedBox(height: 4),
                          Text(
                            userData['email'] ?? '-',
                            style: GoogleFonts.montserrat(fontSize: 13, color: Colors.white.withValues(alpha: 0.9)),
                          ),
                        ],
                      ),
                    ),
                    IconButton(
                      icon: const Icon(Icons.close, color: Colors.white),
                      onPressed: () => Navigator.of(context).pop(),
                    ),
                  ],
                ),
              ),
              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Expanded(
                            child: _buildUserMetricCard(
                              'Role',
                              'Student',
                              Colors.blue,
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: _buildUserMetricCard(
                              'XP',
                              (userData['badges']?['points'] ?? userData['xp'] ?? 0).toString(),
                              const Color(0xFFD62828),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 12),
                      Row(
                        children: [
                          Expanded(
                            child: _buildUserMetricCard(
                              'Created',
                              userData['createdAt'] is Timestamp ? (userData['createdAt'] as Timestamp).toDate().toLocal().toString().split('.')[0] : '-',
                              Colors.green,
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: _buildUserMetricCard(
                              'Last Login',
                              userData['lastLogin'] is Timestamp ? (userData['lastLogin'] as Timestamp).toDate().toLocal().toString().split('.')[0] : '-',
                              Colors.orange,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 20),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.end,
                        children: [
                          TextButton(onPressed: () => _sendMessageToUsers([uid]), child: const Text('Send Message')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: () => _deleteUsers([uid]), style: ElevatedButton.styleFrom(backgroundColor: Colors.red), child: const Text('Delete Student')),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildUserMetricCard(String label, String value, Color color) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: color.withValues(alpha: 0.3)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            label,
            style: GoogleFonts.montserrat(
              fontSize: 12,
              color: Colors.grey[700],
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            value,
            style: GoogleFonts.montserrat(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: color,
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return NestedScrollView(
      headerSliverBuilder: (context, inner) => [
        SliverToBoxAdapter(
          child: Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text('Students', style: GoogleFonts.playfairDisplay(fontSize: 22, fontWeight: FontWeight.bold)),
                const SizedBox(height: 8),
                Text('Search and manage student users in the platform', style: GoogleFonts.montserrat(fontSize: 14, color: Colors.grey[600])),
                const SizedBox(height: 16),

                Container(
                  padding: const EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(12),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withValues(alpha: 0.05),
                        blurRadius: 10,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('Search Students', style: GoogleFonts.playfairDisplay(fontSize: 18, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 12),
                      TextField(
                        controller: _searchController,
                        onChanged: (_) => setState(() {}),
                        decoration: InputDecoration(
                          hintText: 'Search by name or email...',
                          filled: true,
                          fillColor: const Color(0xFFF8FAFE),
                          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                        ),
                      ),
                      const SizedBox(height: 12),
                      Text('Total students: ${_docs.length}', style: GoogleFonts.montserrat(color: Colors.grey[700])),
                      const SizedBox(height: 12),
                      Row(
                        children: [
                          ElevatedButton(onPressed: () => _createUser(), child: const Text('Create Student')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: _selected.isNotEmpty ? () => _deleteUsers(_selected.toList()) : null, child: const Text('Delete Selected')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: () => _sendMessageDialog(), child: const Text('Message')),
                        ],
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
      body: _loadingPage && _docs.isEmpty
          ? const Center(child: CircularProgressIndicator())
          : _docs.isEmpty
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.search_off, size: 64, color: Colors.grey[400]),
                      const SizedBox(height: 16),
                      Text(
                        _searchController.text.isEmpty ? 'No students found' : 'No students match "${_searchController.text}"',
                        style: GoogleFonts.montserrat(color: Colors.grey[600], fontSize: 16),
                      ),
                      if (_searchController.text.isNotEmpty) ...[
                        const SizedBox(height: 8),
                        TextButton(
                          onPressed: () {
                            _searchController.clear();
                            setState(() {});
                          },
                          child: Text('Clear search', style: GoogleFonts.montserrat(color: const Color(0xFFD62828))),
                        ),
                      ],
                    ],
                  ),
                )
              : Container(
                  color: Colors.white,
                  padding: const EdgeInsets.all(12),
                  child: SingleChildScrollView(
                    child: Column(
                      children: [
                        Container(
                          padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 12),
                          color: Colors.grey.shade100,
                          child: Row(
                            children: [
                              SizedBox(width: 50, child: Text('No.', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 3, child: Text('Student', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('Created', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('Last Login', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('XP', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('Rank', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                            ],
                          ),
                        ),
                        const Divider(height: 1),
                        ..._docs.asMap().entries.map((entry) {
                          final index = entry.key;
                          final doc = entry.value;
                          final data = doc.data() as Map<String, dynamic>;
                          final uid = doc.id;
                          final name = (data['displayName'] ?? '${data['firstName'] ?? ''} ${data['lastName'] ?? ''}').toString();
                          final email = (data['email'] ?? '').toString();
                          final created = (data['createdAt'] is Timestamp) ? (data['createdAt'] as Timestamp).toDate() : null;
                          final lastLogin = (data['lastLogin'] is Timestamp) ? (data['lastLogin'] as Timestamp).toDate() : null;
                          final xp = (data['badges'] != null) ? ((data['badges']['points'] ?? 0) as int) : (data['xp'] ?? 0);
                          final rank = (data['rankName'] ?? data['badges']?['level']?.toString() ?? '—').toString();

                          return InkWell(
                            onTap: () => _showUserDetailDialog(data),
                            child: Container(
                              padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 12),
                              decoration: BoxDecoration(border: Border(bottom: BorderSide(color: Colors.grey.shade200))),
                              child: Row(
                                children: [
                                  SizedBox(
                                    width: 50,
                                    child: Text(
                                      '${index + 1}',
                                      style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, fontSize: 13, color: Colors.grey[700]),
                                    ),
                                  ),
                                  Expanded(
                                    flex: 3,
                                    child: Row(children: [
                                      CircleAvatar(
                                        radius: 18,
                                        backgroundColor: const Color(0xFFD62828).withValues(alpha: 0.1),
                                        backgroundImage: (data['avatar'] as String?)?.isNotEmpty == true ? NetworkImage((data['avatar'] as String)) : null,
                                        child: (data['avatar'] as String?) == null 
                                          ? Text(
                                              (name.isNotEmpty ? name[0] : '?').toUpperCase(), 
                                              style: GoogleFonts.montserrat(fontWeight: FontWeight.bold, color: const Color(0xFFD62828))
                                            ) 
                                          : null,
                                      ),
                                      const SizedBox(width: 12),
                                      Expanded(
                                        child: Column(
                                          crossAxisAlignment: CrossAxisAlignment.start,
                                          children: [
                                            Text(
                                              name.isNotEmpty ? name : email, 
                                              style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, fontSize: 13),
                                              overflow: TextOverflow.ellipsis,
                                            ),
                                            if (name.isNotEmpty)
                                              Text(
                                                email, 
                                                style: GoogleFonts.montserrat(fontSize: 11, color: Colors.grey[600]),
                                                overflow: TextOverflow.ellipsis,
                                              ),
                                          ],
                                        ),
                                      ),
                                    ]),
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Text(
                                      created != null ? created.toLocal().toString().split('.')[0] : '—', 
                                      style: GoogleFonts.montserrat(fontSize: 12)
                                    )
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Text(
                                      lastLogin != null ? lastLogin.toLocal().toString().split('.')[0] : '—', 
                                      style: GoogleFonts.montserrat(fontSize: 12)
                                    )
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Text(
                                      xp.toString(), 
                                      style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, color: const Color(0xFFD62828))
                                    )
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                                      decoration: BoxDecoration(
                                        color: rank != '—' ? const Color(0xFFD62828).withValues(alpha: 0.1) : Colors.grey.withValues(alpha: 0.1),
                                        borderRadius: BorderRadius.circular(8),
                                      ),
                                      child: Text(
                                        rank, 
                                        style: GoogleFonts.montserrat(
                                          fontSize: 12,
                                          fontWeight: FontWeight.w600,
                                          color: rank != '—' ? const Color(0xFFD62828) : Colors.grey[700],
                                        )
                                      ),
                                    )
                                  ),
                                ],
                              ),
                            ),
                          );
                        }).toList(),
                        const Divider(height: 1),
                        Padding(
                          padding: const EdgeInsets.symmetric(vertical: 8),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              TextButton(onPressed: _pageStack.isEmpty ? null : _prevPage, child: const Text('Prev')),
                              const SizedBox(width: 16),
                              TextButton(onPressed: _hasMore ? () => _fetchPage() : null, child: const Text('Next')),
                              if (_loadingPage) ...[const SizedBox(width: 16), const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2))],
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
    );
  }
}

class TeacherManagementTab extends StatefulWidget {
  const TeacherManagementTab({Key? key}) : super(key: key);

  @override
  State<TeacherManagementTab> createState() => _TeacherManagementTabState();
}

class _TeacherManagementTabState extends State<TeacherManagementTab> {
  final TextEditingController _searchController = TextEditingController();
  final FirebaseFirestore _db = FirebaseFirestore.instance;
  final FirebaseFunctions _functions = FirebaseFunctions.instance;

  List<QueryDocumentSnapshot> _docs = [];
  final Set<String> _selected = {};

  // pagination
  DocumentSnapshot? _lastDoc;
  bool _hasMore = true;
  bool _loadingPage = false;
  int _pageSize = 20;
  final List<DocumentSnapshot?> _pageStack = [];

  // search / filters
  String _searchQuery = '';

  // prefs
  static const _prefPageSize = 'admin_teachers_pageSize';

  @override
  void initState() {
    super.initState();
    _loadPrefs().then((_) => _fetchPage(reset: true));
    _searchController.addListener(() {
      final q = _searchController.text.trim();
      if (q != _searchQuery) {
        _searchQuery = q;
        _fetchPage(reset: true);
      }
    });
  }

  Future<void> _loadPrefs() async {
    try {
      final sp = await SharedPreferences.getInstance();
      final p = sp.getInt(_prefPageSize) ?? 20;
      setState(() => _pageSize = p);
    } catch (e) {
      // ignore
    }
  }

  Future<void> _savePageSize(int size) async {
    try {
      final sp = await SharedPreferences.getInstance();
      await sp.setInt(_prefPageSize, size);
    } catch (e) {}
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  Future<void> _deleteUsers(List<String> uids) async {
    final ok = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('Confirm delete'),
        content: Text('Are you sure you want to delete ${uids.length} teacher(s)? This will remove their Firestore profile and aggregates. Deleting Auth account requires server-side action.'),
        actions: [
          TextButton(onPressed: () => Navigator.of(ctx).pop(false), child: const Text('Cancel')),
          ElevatedButton(onPressed: () => Navigator.of(ctx).pop(true), child: const Text('Delete')),
        ],
      ),
    );

    if (ok != true) return;

    try {
      final HttpsCallable func = _functions.httpsCallable('adminDeleteUser');
      final resp = await func.call(<String, dynamic>{'uids': uids});
      final data = resp.data as Map<String, dynamic>?;
      int succ = 0;
      if (data != null && data['results'] is Map) {
        final results = Map<String, dynamic>.from(data['results']);
        for (final e in results.entries) if (e.value['success'] == true) succ++;
      }
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Delete requested. Success: $succ of ${uids.length}')));
    } catch (e) {
      final batch = _db.batch();
      for (final uid in uids) {
        batch.delete(_db.collection('users').doc(uid));
        batch.delete(_db.collection('aggregates').doc('user').collection(uid).doc('stats'));
      }
      await batch.commit();
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Firestore profiles deleted. Auth accounts may still exist.')));
    }

    setState(() => _selected.clear());
  }

  Future<void> _sendMessageToUsers(List<String> uids) async {
    final result = await showDialog<Map<String, String>?>(
      context: context,
      builder: (ctx) {
        final titleCtrl = TextEditingController();
        final bodyCtrl = TextEditingController();
        return AlertDialog(
          title: const Text('Send message'),
          content: SizedBox(
            width: 420,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                TextField(controller: titleCtrl, decoration: const InputDecoration(labelText: 'Title')),
                const SizedBox(height: 8),
                TextField(controller: bodyCtrl, decoration: const InputDecoration(labelText: 'Message'), maxLines: 4),
              ],
            ),
          ),
          actions: [
            TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')),
            ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'title': titleCtrl.text, 'body': bodyCtrl.text}), child: const Text('Send')),
          ],
        );
      },
    );

    if (result == null) return;
    final title = result['title'] ?? '';
    final body = result['body'] ?? '';
    final batch = _db.batch();
    final now = FieldValue.serverTimestamp();
    for (final uid in uids) {
      final nref = _db.collection('notifications').doc();
      batch.set(nref, {
        'userId': uid,
        'title': title,
        'message': body,
        'type': 'admin_message',
        'read': false,
        'timestamp': now,
      });
    }
    await batch.commit();

    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Message queued for selected teachers.')));
  }

  Future<void> _createUser() async {
    final data = await showDialog<Map<String, String>?>(
      context: context,
      builder: (ctx) {
        final email = TextEditingController();
        final password = TextEditingController();
        final first = TextEditingController();
        final last = TextEditingController();
        return AlertDialog(
          title: const Text('Create teacher'),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                TextField(controller: email, decoration: const InputDecoration(labelText: 'Email')),
                const SizedBox(height: 8),
                TextField(controller: password, decoration: const InputDecoration(labelText: 'Password')),
                const SizedBox(height: 8),
                Row(children: [Expanded(child: TextField(controller: first, decoration: const InputDecoration(labelText: 'First name'))), const SizedBox(width: 8), Expanded(child: TextField(controller: last, decoration: const InputDecoration(labelText: 'Last name')))]),
              ],
            ),
          ),
          actions: [TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')), ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'email': email.text.trim(), 'password': password.text, 'first': first.text.trim(), 'last': last.text.trim(), 'role': 'teacher'}), child: const Text('Create'))],
        );
      },
    );

    if (data == null) return;

    try {
      final HttpsCallable func = _functions.httpsCallable('adminCreateUser');
      final resp = await func.call(<String, dynamic>{
        'email': data['email'],
        'password': data['password'],
        'firstName': data['first'],
        'lastName': data['last'],
        'role': 'teacher',
      });
      final res = resp.data as Map<String, dynamic>?;
      if (res != null && res['uid'] != null) {
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Teacher created successfully.')));
        _fetchPage(reset: true);
        return;
      }
    } catch (e) {
      // ignore
    }

    final userRef = _db.collection('users').doc();
    await userRef.set({
      'email': data['email'],
      'firstName': data['first'],
      'lastName': data['last'],
      'displayName': '${data['first']} ${data['last']}',
      'role': 'teacher',
      'createdAt': FieldValue.serverTimestamp(),
    });
    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Created teacher document. To create an Auth account, deploy adminCreateUser function.')));
    _fetchPage(reset: true);
  }

  Future<void> _sendMessageDialog() async {
    final result = await showDialog<Map<String, dynamic>?>(
      context: context,
      builder: (ctx) {
        String recipient = 'all';
        final titleCtrl = TextEditingController();
        final bodyCtrl = TextEditingController();
        return StatefulBuilder(
          builder: (ctx, setState) => AlertDialog(
            title: const Text('Send Message'),
            content: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  DropdownButtonFormField<String>(
                    value: recipient,
                    items: [
                      const DropdownMenuItem(value: 'all', child: Text('All Users')),
                      const DropdownMenuItem(value: 'students', child: Text('Students')),
                      const DropdownMenuItem(value: 'teachers', child: Text('Teachers')),
                      const DropdownMenuItem(value: 'school_admins', child: Text('School Admins')),
                      if (_selected.isNotEmpty) const DropdownMenuItem(value: 'selected', child: Text('Selected Users')),
                    ],
                    onChanged: (v) => setState(() => recipient = v ?? 'all'),
                    decoration: const InputDecoration(labelText: 'Recipients'),
                  ),
                  const SizedBox(height: 8),
                  TextField(controller: titleCtrl, decoration: const InputDecoration(labelText: 'Title')),
                  const SizedBox(height: 8),
                  TextField(controller: bodyCtrl, decoration: const InputDecoration(labelText: 'Message'), maxLines: 4),
                ],
              ),
            ),
            actions: [
              TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')),
              ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'recipient': recipient, 'title': titleCtrl.text, 'body': bodyCtrl.text}), child: const Text('Send')),
            ],
          ),
        );
      },
    );

    if (result == null) return;

    final recipient = result['recipient'];
    final title = result['title'] ?? '';
    final body = result['body'] ?? '';
    List<String> uids = [];
    if (recipient == 'selected') {
      uids = _selected.toList();
    } else {
      // fetch all uids for the role
      Query q = _db.collection('users');
      if (recipient != 'all') {
        String role = recipient == 'students' ? 'student' : recipient == 'teachers' ? 'teacher' : 'school_admin';
        q = q.where('role', isEqualTo: role);
      }
      final snap = await q.get();
      uids = snap.docs.map((d) => d.id).toList();
    }

    if (uids.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('No users to send to.')));
      return;
    }

    final batch = _db.batch();
    final now = FieldValue.serverTimestamp();
    for (final uid in uids) {
      final nref = _db.collection('notifications').doc();
      batch.set(nref, {
        'userId': uid,
        'title': title,
        'message': body,
        'type': 'admin_message',
        'read': false,
        'timestamp': now,
      });
    }
    await batch.commit();
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Message sent to ${uids.length} users.')));
  }

  Future<void> _fetchPage({bool reset = false}) async {
    if (_loadingPage) return;
    setState(() => _loadingPage = true);

    if (reset) {
      _docs = [];
      _lastDoc = null;
      _hasMore = true;
      _pageStack.clear();
    }

    if (!_hasMore) {
      setState(() => _loadingPage = false);
      return;
    }

    try {
      Query q = _db.collection('users').where('role', isEqualTo: 'teacher').orderBy('createdAt', descending: true);

      final sq = _searchQuery.trim();
      if (sq.isNotEmpty) {
        if (sq.contains('@')) {
          q = q.where('email', isGreaterThanOrEqualTo: sq).where('email', isLessThanOrEqualTo: sq + '\uf8ff');
        } else {
          q = q.where('displayName', isGreaterThanOrEqualTo: sq).where('displayName', isLessThanOrEqualTo: sq + '\uf8ff');
        }
      }

      q = q.limit(_pageSize);
      if (_lastDoc != null) q = q.startAfterDocument(_lastDoc!);

      final snap = await q.get();
      final docs = snap.docs;
      if (docs.isNotEmpty) {
        _pageStack.add(_lastDoc);
        _lastDoc = docs.last;
        _docs.addAll(docs);
      }

      if (docs.length < _pageSize) _hasMore = false;
    } catch (e) {
      debugPrint('fetchPage error: $e');
    } finally {
      setState(() => _loadingPage = false);
    }
  }

  Future<void> _prevPage() async {
    if (_pageStack.isEmpty) return;
    final prevLast = _pageStack.length >= 1 ? _pageStack[_pageStack.length - 1] : null;
    _pageStack.removeLast();
    _lastDoc = prevLast as DocumentSnapshot?;
    _docs = [];
    _hasMore = true;
    await _fetchPage(reset: true);
  }

  void _showUserDetailDialog(Map<String, dynamic> userData) {
    final uid = userData['uid'] ?? '';
    final avatar = userData['avatar'] as String?;
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        insetPadding: const EdgeInsets.symmetric(horizontal: 40, vertical: 24),
        child: ConstrainedBox(
          constraints: BoxConstraints(
            maxWidth: 600,
            maxHeight: MediaQuery.of(context).size.height * 0.8,
          ),
          child: Column(
            children: [
              Container(
                padding: const EdgeInsets.all(20),
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Color(0xFFD62828), Color(0xFFB71C1C)],
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                  ),
                  borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
                ),
                child: Row(
                  children: [
                    CircleAvatar(
                      radius: 32,
                      backgroundColor: Colors.white,
                      backgroundImage: avatar?.isNotEmpty == true ? NetworkImage(avatar!) : null,
                      child: avatar == null
                          ? Text(
                              ((userData['displayName'] ?? userData['firstName'] ?? '?') as String)[0].toUpperCase(), 
                              style: GoogleFonts.montserrat(fontSize: 20, color: const Color(0xFFD62828), fontWeight: FontWeight.bold)
                            )
                          : null,
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            userData['displayName'] ?? userData['firstName'] ?? '-', 
                            style: GoogleFonts.playfairDisplay(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white)
                          ),
                          const SizedBox(height: 4),
                          Text(
                            userData['email'] ?? '-',
                            style: GoogleFonts.montserrat(fontSize: 13, color: Colors.white.withValues(alpha: 0.9)),
                          ),
                        ],
                      ),
                    ),
                    IconButton(
                      icon: const Icon(Icons.close, color: Colors.white),
                      onPressed: () => Navigator.of(context).pop(),
                    ),
                  ],
                ),
              ),
              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Expanded(
                            child: _buildUserMetricCard(
                              'Role',
                              'Teacher',
                              Colors.blue,
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: _buildUserMetricCard(
                              'XP',
                              (userData['badges']?['points'] ?? userData['xp'] ?? 0).toString(),
                              const Color(0xFFD62828),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 12),
                      Row(
                        children: [
                          Expanded(
                            child: _buildUserMetricCard(
                              'Created',
                              userData['createdAt'] is Timestamp ? (userData['createdAt'] as Timestamp).toDate().toLocal().toString().split('.')[0] : '-',
                              Colors.green,
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: _buildUserMetricCard(
                              'Last Login',
                              userData['lastLogin'] is Timestamp ? (userData['lastLogin'] as Timestamp).toDate().toLocal().toString().split('.')[0] : '-',
                              Colors.orange,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 20),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.end,
                        children: [
                          TextButton(onPressed: () => _sendMessageToUsers([uid]), child: const Text('Send Message')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: () => _deleteUsers([uid]), style: ElevatedButton.styleFrom(backgroundColor: Colors.red), child: const Text('Delete Teacher')),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildUserMetricCard(String label, String value, Color color) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: color.withValues(alpha: 0.3)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            label,
            style: GoogleFonts.montserrat(
              fontSize: 12,
              color: Colors.grey[700],
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            value,
            style: GoogleFonts.montserrat(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: color,
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return NestedScrollView(
      headerSliverBuilder: (context, inner) => [
        SliverToBoxAdapter(
          child: Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text('Teachers', style: GoogleFonts.playfairDisplay(fontSize: 22, fontWeight: FontWeight.bold)),
                const SizedBox(height: 8),
                Text('Search and manage teacher users in the platform', style: GoogleFonts.montserrat(fontSize: 14, color: Colors.grey[600])),
                const SizedBox(height: 16),

                Container(
                  padding: const EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(12),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withValues(alpha: 0.05),
                        blurRadius: 10,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('Search Teachers', style: GoogleFonts.playfairDisplay(fontSize: 18, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 12),
                      TextField(
                        controller: _searchController,
                        onChanged: (_) => setState(() {}),
                        decoration: InputDecoration(
                          hintText: 'Search by name or email...',
                          filled: true,
                          fillColor: const Color(0xFFF8FAFE),
                          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                        ),
                      ),
                      const SizedBox(height: 12),
                      Text('Total teachers: ${_docs.length}', style: GoogleFonts.montserrat(color: Colors.grey[700])),
                      const SizedBox(height: 12),
                      Row(
                        children: [
                          ElevatedButton(onPressed: () => _createUser(), child: const Text('Create Teacher')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: _selected.isNotEmpty ? () => _deleteUsers(_selected.toList()) : null, child: const Text('Delete Selected')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: () => _sendMessageDialog(), child: const Text('Message')),
                        ],
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
      body: _loadingPage && _docs.isEmpty
          ? const Center(child: CircularProgressIndicator())
          : _docs.isEmpty
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.search_off, size: 64, color: Colors.grey[400]),
                      const SizedBox(height: 16),
                      Text(
                        _searchController.text.isEmpty ? 'No teachers found' : 'No teachers match "${_searchController.text}"',
                        style: GoogleFonts.montserrat(color: Colors.grey[600], fontSize: 16),
                      ),
                      if (_searchController.text.isNotEmpty) ...[
                        const SizedBox(height: 8),
                        TextButton(
                          onPressed: () {
                            _searchController.clear();
                            setState(() {});
                          },
                          child: Text('Clear search', style: GoogleFonts.montserrat(color: const Color(0xFFD62828))),
                        ),
                      ],
                    ],
                  ),
                )
              : Container(
                  color: Colors.white,
                  padding: const EdgeInsets.all(12),
                  child: SingleChildScrollView(
                    child: Column(
                      children: [
                        Container(
                          padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 12),
                          color: Colors.grey.shade100,
                          child: Row(
                            children: [
                              SizedBox(width: 50, child: Text('No.', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 3, child: Text('Teacher', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('Created', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('Last Login', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('XP', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('Rank', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                            ],
                          ),
                        ),
                        const Divider(height: 1),
                        ..._docs.asMap().entries.map((entry) {
                          final index = entry.key;
                          final doc = entry.value;
                          final data = doc.data() as Map<String, dynamic>;
                          final uid = doc.id;
                          final name = (data['displayName'] ?? '${data['firstName'] ?? ''} ${data['lastName'] ?? ''}').toString();
                          final email = (data['email'] ?? '').toString();
                          final created = (data['createdAt'] is Timestamp) ? (data['createdAt'] as Timestamp).toDate() : null;
                          final lastLogin = (data['lastLogin'] is Timestamp) ? (data['lastLogin'] as Timestamp).toDate() : null;
                          final xp = (data['badges'] != null) ? ((data['badges']['points'] ?? 0) as int) : (data['xp'] ?? 0);
                          final rank = (data['rankName'] ?? data['badges']?['level']?.toString() ?? '—').toString();

                          return InkWell(
                            onTap: () => _showUserDetailDialog(data),
                            child: Container(
                              padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 12),
                              decoration: BoxDecoration(border: Border(bottom: BorderSide(color: Colors.grey.shade200))),
                              child: Row(
                                children: [
                                  SizedBox(
                                    width: 50,
                                    child: Text(
                                      '${index + 1}',
                                      style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, fontSize: 13, color: Colors.grey[700]),
                                    ),
                                  ),
                                  Expanded(
                                    flex: 3,
                                    child: Row(children: [
                                      CircleAvatar(
                                        radius: 18,
                                        backgroundColor: const Color(0xFFD62828).withValues(alpha: 0.1),
                                        backgroundImage: (data['avatar'] as String?)?.isNotEmpty == true ? NetworkImage((data['avatar'] as String)) : null,
                                        child: (data['avatar'] as String?) == null 
                                          ? Text(
                                              (name.isNotEmpty ? name[0] : '?').toUpperCase(), 
                                              style: GoogleFonts.montserrat(fontWeight: FontWeight.bold, color: const Color(0xFFD62828))
                                            ) 
                                          : null,
                                      ),
                                      const SizedBox(width: 12),
                                      Expanded(
                                        child: Column(
                                          crossAxisAlignment: CrossAxisAlignment.start,
                                          children: [
                                            Text(
                                              name.isNotEmpty ? name : email, 
                                              style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, fontSize: 13),
                                              overflow: TextOverflow.ellipsis,
                                            ),
                                            if (name.isNotEmpty)
                                              Text(
                                                email, 
                                                style: GoogleFonts.montserrat(fontSize: 11, color: Colors.grey[600]),
                                                overflow: TextOverflow.ellipsis,
                                              ),
                                          ],
                                        ),
                                      ),
                                    ]),
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Text(
                                      created != null ? created.toLocal().toString().split('.')[0] : '—', 
                                      style: GoogleFonts.montserrat(fontSize: 12)
                                    )
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Text(
                                      lastLogin != null ? lastLogin.toLocal().toString().split('.')[0] : '—', 
                                      style: GoogleFonts.montserrat(fontSize: 12)
                                    )
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Text(
                                      xp.toString(), 
                                      style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, color: const Color(0xFFD62828))
                                    )
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                                      decoration: BoxDecoration(
                                        color: rank != '—' ? const Color(0xFFD62828).withValues(alpha: 0.1) : Colors.grey.withValues(alpha: 0.1),
                                        borderRadius: BorderRadius.circular(8),
                                      ),
                                      child: Text(
                                        rank, 
                                        style: GoogleFonts.montserrat(
                                          fontSize: 12,
                                          fontWeight: FontWeight.w600,
                                          color: rank != '—' ? const Color(0xFFD62828) : Colors.grey[700],
                                        )
                                      ),
                                    )
                                  ),
                                ],
                              ),
                            ),
                          );
                        }).toList(),
                        const Divider(height: 1),
                        Padding(
                          padding: const EdgeInsets.symmetric(vertical: 8),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              TextButton(onPressed: _pageStack.isEmpty ? null : _prevPage, child: const Text('Prev')),
                              const SizedBox(width: 16),
                              TextButton(onPressed: _hasMore ? () => _fetchPage() : null, child: const Text('Next')),
                              if (_loadingPage) ...[const SizedBox(width: 16), const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2))],
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
    );
  }
}

class SchoolAdminManagementTab extends StatefulWidget {
  const SchoolAdminManagementTab({Key? key}) : super(key: key);

  @override
  State<SchoolAdminManagementTab> createState() => _SchoolAdminManagementTabState();
}

class _SchoolAdminManagementTabState extends State<SchoolAdminManagementTab> {
  final TextEditingController _searchController = TextEditingController();
  final FirebaseFirestore _db = FirebaseFirestore.instance;
  final FirebaseFunctions _functions = FirebaseFunctions.instance;

  List<QueryDocumentSnapshot> _docs = [];
  final Set<String> _selected = {};

  // pagination
  DocumentSnapshot? _lastDoc;
  bool _hasMore = true;
  bool _loadingPage = false;
  int _pageSize = 20;
  final List<DocumentSnapshot?> _pageStack = [];

  // search / filters
  String _searchQuery = '';

  // prefs
  static const _prefPageSize = 'admin_schooladmins_pageSize';

  @override
  void initState() {
    super.initState();
    _loadPrefs().then((_) => _fetchPage(reset: true));
    _searchController.addListener(() {
      final q = _searchController.text.trim();
      if (q != _searchQuery) {
        _searchQuery = q;
        _fetchPage(reset: true);
      }
    });
  }

  Future<void> _loadPrefs() async {
    try {
      final sp = await SharedPreferences.getInstance();
      final p = sp.getInt(_prefPageSize) ?? 20;
      setState(() => _pageSize = p);
    } catch (e) {
      // ignore
    }
  }

  Future<void> _savePageSize(int size) async {
    try {
      final sp = await SharedPreferences.getInstance();
      await sp.setInt(_prefPageSize, size);
    } catch (e) {}
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  Future<void> _deleteUsers(List<String> uids) async {
    final ok = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('Confirm delete'),
        content: Text('Are you sure you want to delete ${uids.length} school admin(s)? This will remove their Firestore profile and aggregates. Deleting Auth account requires server-side action.'),
        actions: [
          TextButton(onPressed: () => Navigator.of(ctx).pop(false), child: const Text('Cancel')),
          ElevatedButton(onPressed: () => Navigator.of(ctx).pop(true), child: const Text('Delete')),
        ],
      ),
    );

    if (ok != true) return;

    try {
      final HttpsCallable func = _functions.httpsCallable('adminDeleteUser');
      final resp = await func.call(<String, dynamic>{'uids': uids});
      final data = resp.data as Map<String, dynamic>?;
      int succ = 0;
      if (data != null && data['results'] is Map) {
        final results = Map<String, dynamic>.from(data['results']);
        for (final e in results.entries) if (e.value['success'] == true) succ++;
      }
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Delete requested. Success: $succ of ${uids.length}')));
    } catch (e) {
      final batch = _db.batch();
      for (final uid in uids) {
        batch.delete(_db.collection('users').doc(uid));
        batch.delete(_db.collection('aggregates').doc('user').collection(uid).doc('stats'));
      }
      await batch.commit();
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Firestore profiles deleted. Auth accounts may still exist.')));
    }

    setState(() => _selected.clear());
  }

  Future<void> _sendMessageToUsers(List<String> uids) async {
    final result = await showDialog<Map<String, String>?>(
      context: context,
      builder: (ctx) {
        final titleCtrl = TextEditingController();
        final bodyCtrl = TextEditingController();
        return AlertDialog(
          title: const Text('Send message'),
          content: SizedBox(
            width: 420,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                TextField(controller: titleCtrl, decoration: const InputDecoration(labelText: 'Title')),
                const SizedBox(height: 8),
                TextField(controller: bodyCtrl, decoration: const InputDecoration(labelText: 'Message'), maxLines: 4),
              ],
            ),
          ),
          actions: [
            TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')),
            ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'title': titleCtrl.text, 'body': bodyCtrl.text}), child: const Text('Send')),
          ],
        );
      },
    );

    if (result == null) return;
    final title = result['title'] ?? '';
    final body = result['body'] ?? '';
    final batch = _db.batch();
    final now = FieldValue.serverTimestamp();
    for (final uid in uids) {
      final nref = _db.collection('notifications').doc();
      batch.set(nref, {
        'userId': uid,
        'title': title,
        'message': body,
        'type': 'admin_message',
        'read': false,
        'timestamp': now,
      });
    }
    await batch.commit();

    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Message queued for selected school admins.')));
  }

  Future<void> _createUser() async {
    final data = await showDialog<Map<String, String>?>(
      context: context,
      builder: (ctx) {
        final email = TextEditingController();
        final password = TextEditingController();
        final first = TextEditingController();
        final last = TextEditingController();
        return AlertDialog(
          title: const Text('Create school admin'),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                TextField(controller: email, decoration: const InputDecoration(labelText: 'Email')),
                const SizedBox(height: 8),
                TextField(controller: password, decoration: const InputDecoration(labelText: 'Password')),
                const SizedBox(height: 8),
                Row(children: [Expanded(child: TextField(controller: first, decoration: const InputDecoration(labelText: 'First name'))), const SizedBox(width: 8), Expanded(child: TextField(controller: last, decoration: const InputDecoration(labelText: 'Last name')))]),
              ],
            ),
          ),
          actions: [TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')), ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'email': email.text.trim(), 'password': password.text, 'first': first.text.trim(), 'last': last.text.trim(), 'role': 'school_admin'}), child: const Text('Create'))],
        );
      },
    );

    if (data == null) return;

    try {
      final HttpsCallable func = _functions.httpsCallable('adminCreateUser');
      final resp = await func.call(<String, dynamic>{
        'email': data['email'],
        'password': data['password'],
        'firstName': data['first'],
        'lastName': data['last'],
        'role': 'school_admin',
      });
      final res = resp.data as Map<String, dynamic>?;
      if (res != null && res['uid'] != null) {
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('School admin created successfully.')));
        _fetchPage(reset: true);
        return;
      }
    } catch (e) {
      // ignore
    }

    final userRef = _db.collection('users').doc();
    await userRef.set({
      'email': data['email'],
      'firstName': data['first'],
      'lastName': data['last'],
      'displayName': '${data['first']} ${data['last']}',
      'role': 'school_admin',
      'createdAt': FieldValue.serverTimestamp(),
    });
    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Created school admin document. To create an Auth account, deploy adminCreateUser function.')));
    _fetchPage(reset: true);
  }

  Future<void> _sendMessageDialog() async {
    final result = await showDialog<Map<String, dynamic>?>(
      context: context,
      builder: (ctx) {
        String recipient = 'all';
        final titleCtrl = TextEditingController();
        final bodyCtrl = TextEditingController();
        return StatefulBuilder(
          builder: (ctx, setState) => AlertDialog(
            title: const Text('Send Message'),
            content: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  DropdownButtonFormField<String>(
                    value: recipient,
                    items: [
                      const DropdownMenuItem(value: 'all', child: Text('All Users')),
                      const DropdownMenuItem(value: 'students', child: Text('Students')),
                      const DropdownMenuItem(value: 'teachers', child: Text('Teachers')),
                      const DropdownMenuItem(value: 'school_admins', child: Text('School Admins')),
                      if (_selected.isNotEmpty) const DropdownMenuItem(value: 'selected', child: Text('Selected Users')),
                    ],
                    onChanged: (v) => setState(() => recipient = v ?? 'all'),
                    decoration: const InputDecoration(labelText: 'Recipients'),
                  ),
                  const SizedBox(height: 8),
                  TextField(controller: titleCtrl, decoration: const InputDecoration(labelText: 'Title')),
                  const SizedBox(height: 8),
                  TextField(controller: bodyCtrl, decoration: const InputDecoration(labelText: 'Message'), maxLines: 4),
                ],
              ),
            ),
            actions: [
              TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')),
              ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'recipient': recipient, 'title': titleCtrl.text, 'body': bodyCtrl.text}), child: const Text('Send')),
            ],
          ),
        );
      },
    );

    if (result == null) return;

    final recipient = result['recipient'];
    final title = result['title'] ?? '';
    final body = result['body'] ?? '';
    List<String> uids = [];
    if (recipient == 'selected') {
      uids = _selected.toList();
    } else {
      // fetch all uids for the role
      Query q = _db.collection('users');
      if (recipient != 'all') {
        String role = recipient == 'students' ? 'student' : recipient == 'teachers' ? 'teacher' : 'school_admin';
        q = q.where('role', isEqualTo: role);
      }
      final snap = await q.get();
      uids = snap.docs.map((d) => d.id).toList();
    }

    if (uids.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('No users to send to.')));
      return;
    }

    final batch = _db.batch();
    final now = FieldValue.serverTimestamp();
    for (final uid in uids) {
      final nref = _db.collection('notifications').doc();
      batch.set(nref, {
        'userId': uid,
        'title': title,
        'message': body,
        'type': 'admin_message',
        'read': false,
        'timestamp': now,
      });
    }
    await batch.commit();
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Message sent to ${uids.length} users.')));
  }

  Future<void> _fetchPage({bool reset = false}) async {
    if (_loadingPage) return;
    setState(() => _loadingPage = true);

    if (reset) {
      _docs = [];
      _lastDoc = null;
      _hasMore = true;
      _pageStack.clear();
    }

    if (!_hasMore) {
      setState(() => _loadingPage = false);
      return;
    }

    try {
      Query q = _db.collection('users').where('role', isEqualTo: 'school_admin').orderBy('createdAt', descending: true);

      final sq = _searchQuery.trim();
      if (sq.isNotEmpty) {
        if (sq.contains('@')) {
          q = q.where('email', isGreaterThanOrEqualTo: sq).where('email', isLessThanOrEqualTo: sq + '\uf8ff');
        } else {
          q = q.where('displayName', isGreaterThanOrEqualTo: sq).where('displayName', isLessThanOrEqualTo: sq + '\uf8ff');
        }
      }

      q = q.limit(_pageSize);
      if (_lastDoc != null) q = q.startAfterDocument(_lastDoc!);

      final snap = await q.get();
      final docs = snap.docs;
      if (docs.isNotEmpty) {
        _pageStack.add(_lastDoc);
        _lastDoc = docs.last;
        _docs.addAll(docs);
      }

      if (docs.length < _pageSize) _hasMore = false;
    } catch (e) {
      debugPrint('fetchPage error: $e');
    } finally {
      setState(() => _loadingPage = false);
    }
  }

  Future<void> _prevPage() async {
    if (_pageStack.isEmpty) return;
    final prevLast = _pageStack.length >= 1 ? _pageStack[_pageStack.length - 1] : null;
    _pageStack.removeLast();
    _lastDoc = prevLast as DocumentSnapshot?;
    _docs = [];
    _hasMore = true;
    await _fetchPage(reset: true);
  }

  void _showUserDetailDialog(Map<String, dynamic> userData) {
    final uid = userData['uid'] ?? '';
    final avatar = userData['avatar'] as String?;
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        insetPadding: const EdgeInsets.symmetric(horizontal: 40, vertical: 24),
        child: ConstrainedBox(
          constraints: BoxConstraints(
            maxWidth: 600,
            maxHeight: MediaQuery.of(context).size.height * 0.8,
          ),
          child: Column(
            children: [
              Container(
                padding: const EdgeInsets.all(20),
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Color(0xFFD62828), Color(0xFFB71C1C)],
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                  ),
                  borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
                ),
                child: Row(
                  children: [
                    CircleAvatar(
                      radius: 32,
                      backgroundColor: Colors.white,
                      backgroundImage: avatar?.isNotEmpty == true ? NetworkImage(avatar!) : null,
                      child: avatar == null
                          ? Text(
                              ((userData['displayName'] ?? userData['firstName'] ?? '?') as String)[0].toUpperCase(), 
                              style: GoogleFonts.montserrat(fontSize: 20, color: const Color(0xFFD62828), fontWeight: FontWeight.bold)
                            )
                          : null,
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            userData['displayName'] ?? userData['firstName'] ?? '-', 
                            style: GoogleFonts.playfairDisplay(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white)
                          ),
                          const SizedBox(height: 4),
                          Text(
                            userData['email'] ?? '-',
                            style: GoogleFonts.montserrat(fontSize: 13, color: Colors.white.withValues(alpha: 0.9)),
                          ),
                        ],
                      ),
                    ),
                    IconButton(
                      icon: const Icon(Icons.close, color: Colors.white),
                      onPressed: () => Navigator.of(context).pop(),
                    ),
                  ],
                ),
              ),
              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Expanded(
                            child: _buildUserMetricCard(
                              'Role',
                              'School Admin',
                              Colors.blue,
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: _buildUserMetricCard(
                              'XP',
                              (userData['badges']?['points'] ?? userData['xp'] ?? 0).toString(),
                              const Color(0xFFD62828),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 12),
                      Row(
                        children: [
                          Expanded(
                            child: _buildUserMetricCard(
                              'Created',
                              userData['createdAt'] is Timestamp ? (userData['createdAt'] as Timestamp).toDate().toLocal().toString().split('.')[0] : '-',
                              Colors.green,
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: _buildUserMetricCard(
                              'Last Login',
                              userData['lastLogin'] is Timestamp ? (userData['lastLogin'] as Timestamp).toDate().toLocal().toString().split('.')[0] : '-',
                              Colors.orange,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 20),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.end,
                        children: [
                          TextButton(onPressed: () => _sendMessageToUsers([uid]), child: const Text('Send Message')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: () => _deleteUsers([uid]), style: ElevatedButton.styleFrom(backgroundColor: Colors.red), child: const Text('Delete Admin')),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildUserMetricCard(String label, String value, Color color) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: color.withValues(alpha: 0.3)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            label,
            style: GoogleFonts.montserrat(
              fontSize: 12,
              color: Colors.grey[700],
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            value,
            style: GoogleFonts.montserrat(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: color,
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return NestedScrollView(
      headerSliverBuilder: (context, inner) => [
        SliverToBoxAdapter(
          child: Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text('School Admins', style: GoogleFonts.playfairDisplay(fontSize: 22, fontWeight: FontWeight.bold)),
                const SizedBox(height: 8),
                Text('Search and manage school admin users in the platform', style: GoogleFonts.montserrat(fontSize: 14, color: Colors.grey[600])),
                const SizedBox(height: 16),

                Container(
                  padding: const EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(12),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withValues(alpha: 0.05),
                        blurRadius: 10,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('Search School Admins', style: GoogleFonts.playfairDisplay(fontSize: 18, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 12),
                      TextField(
                        controller: _searchController,
                        onChanged: (_) => setState(() {}),
                        decoration: InputDecoration(
                          hintText: 'Search by name or email...',
                          filled: true,
                          fillColor: const Color(0xFFF8FAFE),
                          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                        ),
                      ),
                      const SizedBox(height: 12),
                      Text('Total school admins: ${_docs.length}', style: GoogleFonts.montserrat(color: Colors.grey[700])),
                      const SizedBox(height: 12),
                      Row(
                        children: [
                          ElevatedButton(onPressed: () => _createUser(), child: const Text('Create Admin')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: _selected.isNotEmpty ? () => _deleteUsers(_selected.toList()) : null, child: const Text('Delete Selected')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: () => _sendMessageDialog(), child: const Text('Message')),
                        ],
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
      body: _loadingPage && _docs.isEmpty
          ? const Center(child: CircularProgressIndicator())
          : _docs.isEmpty
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.search_off, size: 64, color: Colors.grey[400]),
                      const SizedBox(height: 16),
                      Text(
                        _searchController.text.isEmpty ? 'No school admins found' : 'No school admins match "${_searchController.text}"',
                        style: GoogleFonts.montserrat(color: Colors.grey[600], fontSize: 16),
                      ),
                      if (_searchController.text.isNotEmpty) ...[
                        const SizedBox(height: 8),
                        TextButton(
                          onPressed: () {
                            _searchController.clear();
                            setState(() {});
                          },
                          child: Text('Clear search', style: GoogleFonts.montserrat(color: const Color(0xFFD62828))),
                        ),
                      ],
                    ],
                  ),
                )
              : Container(
                  color: Colors.white,
                  padding: const EdgeInsets.all(12),
                  child: SingleChildScrollView(
                    child: Column(
                      children: [
                        Container(
                          padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 12),
                          color: Colors.grey.shade100,
                          child: Row(
                            children: [
                              SizedBox(width: 50, child: Text('No.', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 3, child: Text('School Admin', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('Created', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('Last Login', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('XP', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                              Expanded(flex: 1, child: Text('Rank', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                            ],
                          ),
                        ),
                        const Divider(height: 1),
                        ..._docs.asMap().entries.map((entry) {
                          final index = entry.key;
                          final doc = entry.value;
                          final data = doc.data() as Map<String, dynamic>;
                          final uid = doc.id;
                          final name = (data['displayName'] ?? '${data['firstName'] ?? ''} ${data['lastName'] ?? ''}').toString();
                          final email = (data['email'] ?? '').toString();
                          final created = (data['createdAt'] is Timestamp) ? (data['createdAt'] as Timestamp).toDate() : null;
                          final lastLogin = (data['lastLogin'] is Timestamp) ? (data['lastLogin'] as Timestamp).toDate() : null;
                          final xp = (data['badges'] != null) ? ((data['badges']['points'] ?? 0) as int) : (data['xp'] ?? 0);
                          final rank = (data['rankName'] ?? data['badges']?['level']?.toString() ?? '—').toString();

                          return InkWell(
                            onTap: () => _showUserDetailDialog(data),
                            child: Container(
                              padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 12),
                              decoration: BoxDecoration(border: Border(bottom: BorderSide(color: Colors.grey.shade200))),
                              child: Row(
                                children: [
                                  SizedBox(
                                    width: 50,
                                    child: Text(
                                      '${index + 1}',
                                      style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, fontSize: 13, color: Colors.grey[700]),
                                    ),
                                  ),
                                  Expanded(
                                    flex: 3,
                                    child: Row(children: [
                                      CircleAvatar(
                                        radius: 18,
                                        backgroundColor: const Color(0xFFD62828).withValues(alpha: 0.1),
                                        backgroundImage: (data['avatar'] as String?)?.isNotEmpty == true ? NetworkImage((data['avatar'] as String)) : null,
                                        child: (data['avatar'] as String?) == null 
                                          ? Text(
                                              (name.isNotEmpty ? name[0] : '?').toUpperCase(), 
                                              style: GoogleFonts.montserrat(fontWeight: FontWeight.bold, color: const Color(0xFFD62828))
                                            ) 
                                          : null,
                                      ),
                                      const SizedBox(width: 12),
                                      Expanded(
                                        child: Column(
                                          crossAxisAlignment: CrossAxisAlignment.start,
                                          children: [
                                            Text(
                                              name.isNotEmpty ? name : email, 
                                              style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, fontSize: 13),
                                              overflow: TextOverflow.ellipsis,
                                            ),
                                            if (name.isNotEmpty)
                                              Text(
                                                email, 
                                                style: GoogleFonts.montserrat(fontSize: 11, color: Colors.grey[600]),
                                                overflow: TextOverflow.ellipsis,
                                              ),
                                          ],
                                        ),
                                      ),
                                    ]),
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Text(
                                      created != null ? created.toLocal().toString().split('.')[0] : '—', 
                                      style: GoogleFonts.montserrat(fontSize: 12)
                                    )
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Text(
                                      lastLogin != null ? lastLogin.toLocal().toString().split('.')[0] : '—', 
                                      style: GoogleFonts.montserrat(fontSize: 12)
                                    )
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Text(
                                      xp.toString(), 
                                      style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, color: const Color(0xFFD62828))
                                    )
                                  ),
                                  Expanded(
                                    flex: 1,
                                    child: Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                                      decoration: BoxDecoration(
                                        color: rank != '—' ? const Color(0xFFD62828).withValues(alpha: 0.1) : Colors.grey.withValues(alpha: 0.1),
                                        borderRadius: BorderRadius.circular(8),
                                      ),
                                      child: Text(
                                        rank, 
                                        style: GoogleFonts.montserrat(
                                          fontSize: 12,
                                          fontWeight: FontWeight.w600,
                                          color: rank != '—' ? const Color(0xFFD62828) : Colors.grey[700],
                                        )
                                      ),
                                    )
                                  ),
                                ],
                              ),
                            ),
                          );
                        }).toList(),
                        const Divider(height: 1),
                        Padding(
                          padding: const EdgeInsets.symmetric(vertical: 8),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              TextButton(onPressed: _pageStack.isEmpty ? null : _prevPage, child: const Text('Prev')),
                              const SizedBox(width: 16),
                              TextButton(onPressed: _hasMore ? () => _fetchPage() : null, child: const Text('Next')),
                              if (_loadingPage) ...[const SizedBox(width: 16), const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2))],
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
    );
  }
}

class AllUsersTab extends StatefulWidget {
  const AllUsersTab({Key? key}) : super(key: key);

  @override
  State<AllUsersTab> createState() => _AllUsersTabState();
}

class _AllUsersTabState extends State<AllUsersTab> {
  final TextEditingController _searchController = TextEditingController();
  final FirebaseFirestore _db = FirebaseFirestore.instance;
  final FirebaseFunctions _functions = FirebaseFunctions.instance;

  List<QueryDocumentSnapshot> _docs = [];
  final Set<String> _selected = {};
  int? _hoverIndex;

  // pagination
  DocumentSnapshot? _lastDoc;
  bool _hasMore = true;
  bool _loadingPage = false;
  int _pageSize = 20;
  final List<DocumentSnapshot?> _pageStack = [];

  // search / filters
  String _searchQuery = '';
  String? _roleFilter;

  // prefs
  static const _prefPageSize = 'admin_users_pageSize';

  @override
  void initState() {
    super.initState();
    _loadPrefs().then((_) => _fetchPage(reset: true));
    _searchController.addListener(() {
      final q = _searchController.text.trim();
      if (q != _searchQuery) {
        _searchQuery = q;
        _fetchPage(reset: true);
      }
    });
  }

  Future<void> _loadPrefs() async {
    try {
      final sp = await SharedPreferences.getInstance();
      final p = sp.getInt(_prefPageSize) ?? 20;
      setState(() => _pageSize = p);
    } catch (e) {
      // ignore
    }
  }

  Future<void> _savePageSize(int size) async {
    try {
      final sp = await SharedPreferences.getInstance();
      await sp.setInt(_prefPageSize, size);
    } catch (e) {}
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  Future<void> _deleteUsers(List<String> uids) async {
    final ok = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('Confirm delete'),
        content: Text('Are you sure you want to delete ${uids.length} user(s)? This will remove their Firestore profile and aggregates. Deleting Auth account requires server-side action.'),
        actions: [
          TextButton(onPressed: () => Navigator.of(ctx).pop(false), child: const Text('Cancel')),
          ElevatedButton(onPressed: () => Navigator.of(ctx).pop(true), child: const Text('Delete')),
        ],
      ),
    );

    if (ok != true) return;

    // call the server-side adminDeleteUser callable; it will remove Auth accounts and Firestore profiles
    try {
      final HttpsCallable func = _functions.httpsCallable('adminDeleteUser');
      final resp = await func.call(<String, dynamic>{'uids': uids});
      final data = resp.data as Map<String, dynamic>?;
      // show result summary
      int succ = 0;
      if (data != null && data['results'] is Map) {
        final results = Map<String, dynamic>.from(data['results']);
        for (final e in results.entries) if (e.value['success'] == true) succ++;
      }
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Delete requested. Success: $succ of ${uids.length}')));
    } catch (e) {
      // fallback: delete Firestore profiles only
      final batch = _db.batch();
      for (final uid in uids) {
        batch.delete(_db.collection('users').doc(uid));
        batch.delete(_db.collection('aggregates').doc('user').collection(uid).doc('stats'));
      }
      await batch.commit();
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Firestore profiles deleted. Auth accounts may still exist.')));
    }

    setState(() => _selected.clear());
  }

  Future<void> _sendMessageToUsers(List<String> uids) async {
    final result = await showDialog<Map<String, String>?>(
      context: context,
      builder: (ctx) {
        final titleCtrl = TextEditingController();
        final bodyCtrl = TextEditingController();
        return AlertDialog(
          title: const Text('Send message'),
          content: SizedBox(
            width: 420,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                TextField(controller: titleCtrl, decoration: const InputDecoration(labelText: 'Title')),
                const SizedBox(height: 8),
                TextField(controller: bodyCtrl, decoration: const InputDecoration(labelText: 'Message'), maxLines: 4),
              ],
            ),
          ),
          actions: [
            TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')),
            ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'title': titleCtrl.text, 'body': bodyCtrl.text}), child: const Text('Send')),
          ],
        );
      },
    );

    if (result == null) return;
    final title = result['title'] ?? '';
    final body = result['body'] ?? '';
    final batch = _db.batch();
    final now = FieldValue.serverTimestamp();
    for (final uid in uids) {
      final nref = _db.collection('notifications').doc();
      batch.set(nref, {
        'userId': uid,
        'title': title,
        'message': body,
        'type': 'admin_message',
        'read': false,
        'timestamp': now,
      });
    }
    await batch.commit();

    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Message queued for selected users.')));
  }

  Future<void> _createUser() async {
    final data = await showDialog<Map<String, String>?>(
      context: context,
      builder: (ctx) {
        final email = TextEditingController();
        final password = TextEditingController();
        final first = TextEditingController();
        final last = TextEditingController();
        String role = 'student';
        return StatefulBuilder(builder: (ctx, setState) {
          return AlertDialog(
            title: const Text('Create user'),
            content: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  TextField(controller: email, decoration: const InputDecoration(labelText: 'Email')),
                  const SizedBox(height: 8),
                  TextField(controller: password, decoration: const InputDecoration(labelText: 'Password')),
                  const SizedBox(height: 8),
                  Row(children: [Expanded(child: TextField(controller: first, decoration: const InputDecoration(labelText: 'First name'))), const SizedBox(width: 8), Expanded(child: TextField(controller: last, decoration: const InputDecoration(labelText: 'Last name')))]),
                  const SizedBox(height: 12),
                  DropdownButtonFormField<String>(
                    value: role,
                    items: const [DropdownMenuItem(value: 'student', child: Text('Student')), DropdownMenuItem(value: 'teacher', child: Text('Teacher')), DropdownMenuItem(value: 'school_admin', child: Text('School Admin'))],
                    onChanged: (v) => setState(() => role = v ?? 'student'),
                    decoration: const InputDecoration(labelText: 'Role'),
                  )
                ],
              ),
            ),
            actions: [TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')), ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'email': email.text.trim(), 'password': password.text, 'first': first.text.trim(), 'last': last.text.trim(), 'role': role}), child: const Text('Create'))],
          );
        });
      },
    );

    if (data == null) return;

    // Try calling callable admin create function; fallback: write user doc (no auth creation)
    try {
      final HttpsCallable func = _functions.httpsCallable('adminCreateUser');
      final resp = await func.call(<String, dynamic>{
        'email': data['email'],
        'password': data['password'],
        'firstName': data['first'],
        'lastName': data['last'],
        'role': data['role'],
      });
      final res = resp.data as Map<String, dynamic>?;
      if (res != null && res['uid'] != null) {
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('User created successfully.')));
        // refresh list
        _fetchPage(reset: true);
        return;
      }
    } catch (e) {
      // ignore; fallback below
    }

    // Fallback: create a Firestore user document only (no Firebase Auth account)
    final userRef = _db.collection('users').doc();
    await userRef.set({
      'email': data['email'],
      'firstName': data['first'],
      'lastName': data['last'],
      'displayName': '${data['first']} ${data['last']}',
      'role': data['role'],
      'createdAt': FieldValue.serverTimestamp(),
    });
    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Created user document. To create an Auth account, deploy adminCreateUser function.')));
    // refresh
    _fetchPage(reset: true);
  }

  Future<void> _sendMessageDialog() async {
    final result = await showDialog<Map<String, dynamic>?>(
      context: context,
      builder: (ctx) {
        String recipient = 'all';
        final titleCtrl = TextEditingController();
        final bodyCtrl = TextEditingController();
        return StatefulBuilder(
          builder: (ctx, setState) => AlertDialog(
            title: const Text('Send Message'),
            content: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  DropdownButtonFormField<String>(
                    value: recipient,
                    items: [
                      const DropdownMenuItem(value: 'all', child: Text('All Users')),
                      const DropdownMenuItem(value: 'students', child: Text('Students')),
                      const DropdownMenuItem(value: 'teachers', child: Text('Teachers')),
                      const DropdownMenuItem(value: 'school_admins', child: Text('School Admins')),
                      if (_selected.isNotEmpty) const DropdownMenuItem(value: 'selected', child: Text('Selected Users')),
                    ],
                    onChanged: (v) => setState(() => recipient = v ?? 'all'),
                    decoration: const InputDecoration(labelText: 'Recipients'),
                  ),
                  const SizedBox(height: 8),
                  TextField(controller: titleCtrl, decoration: const InputDecoration(labelText: 'Title')),
                  const SizedBox(height: 8),
                  TextField(controller: bodyCtrl, decoration: const InputDecoration(labelText: 'Message'), maxLines: 4),
                ],
              ),
            ),
            actions: [
              TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('Cancel')),
              ElevatedButton(onPressed: () => Navigator.of(ctx).pop({'recipient': recipient, 'title': titleCtrl.text, 'body': bodyCtrl.text}), child: const Text('Send')),
            ],
          ),
        );
      },
    );

    if (result == null) return;

    final recipient = result['recipient'];
    final title = result['title'] ?? '';
    final body = result['body'] ?? '';
    List<String> uids = [];
    if (recipient == 'selected') {
      uids = _selected.toList();
    } else {
      // fetch all uids for the role
      Query q = _db.collection('users');
      if (recipient != 'all') {
        String role = recipient == 'students' ? 'student' : recipient == 'teachers' ? 'teacher' : 'school_admin';
        q = q.where('role', isEqualTo: role);
      }
      final snap = await q.get();
      uids = snap.docs.map((d) => d.id).toList();
    }

    if (uids.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('No users to send to.')));
      return;
    }

    final batch = _db.batch();
    final now = FieldValue.serverTimestamp();
    for (final uid in uids) {
      final nref = _db.collection('notifications').doc();
      batch.set(nref, {
        'userId': uid,
        'title': title,
        'message': body,
        'type': 'admin_message',
        'read': false,
        'timestamp': now,
      });
    }
    await batch.commit();
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Message sent to ${uids.length} users.')));
  }

  Future<void> _fetchPage({bool reset = false}) async {
    if (_loadingPage) return;
    setState(() => _loadingPage = true);

    if (reset) {
      _docs = [];
      _lastDoc = null;
      _hasMore = true;
      _pageStack.clear();
    }

    if (!_hasMore) {
      setState(() => _loadingPage = false);
      return;
    }

    try {
      Query q = _db.collection('users').orderBy('createdAt', descending: true);

      if (_roleFilter != null && _roleFilter!.isNotEmpty) {
        q = q.where('role', isEqualTo: _roleFilter);
      }

      final sq = _searchQuery.trim();
      if (sq.isNotEmpty) {
        // If query looks like an email (contains @) do prefix on email, else prefix on displayName
        if (sq.contains('@')) {
          q = q.where('email', isGreaterThanOrEqualTo: sq).where('email', isLessThanOrEqualTo: sq + '\uf8ff');
        } else {
          q = q.where('displayName', isGreaterThanOrEqualTo: sq).where('displayName', isLessThanOrEqualTo: sq + '\uf8ff');
        }
      }

      q = q.limit(_pageSize);
      if (_lastDoc != null) q = q.startAfterDocument(_lastDoc!);

      final snap = await q.get();
      final docs = snap.docs;
      if (docs.isNotEmpty) {
        _pageStack.add(_lastDoc);
        _lastDoc = docs.last;
        _docs.addAll(docs);
      }

      if (docs.length < _pageSize) _hasMore = false;
    } catch (e) {
      debugPrint('fetchPage error: $e');
    } finally {
      setState(() => _loadingPage = false);
    }
  }

  Future<void> _prevPage() async {
    if (_pageStack.isEmpty) return;
    // simple strategy: reset and fetch until we reach previous page stack length-1
    final prevLast = _pageStack.length >= 1 ? _pageStack[_pageStack.length - 1] : null;
    _pageStack.removeLast();
    _lastDoc = prevLast as DocumentSnapshot?;
    // rebuild docs from scratch up to lastDoc
    _docs = [];
    _hasMore = true;
    await _fetchPage(reset: true);
  }

  @override
  Widget build(BuildContext context) {
    return NestedScrollView(
      headerSliverBuilder: (context, inner) => [
        SliverToBoxAdapter(
          child: Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text('All Users', style: GoogleFonts.playfairDisplay(fontSize: 22, fontWeight: FontWeight.bold)),
                const SizedBox(height: 8),
                Text('Search and manage all users in the platform', style: GoogleFonts.montserrat(fontSize: 14, color: Colors.grey[600])),
                const SizedBox(height: 16),

                // Search Card
                Container(
                  padding: const EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(12),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withValues(alpha: 0.05),
                        blurRadius: 10,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('Search Users', style: GoogleFonts.playfairDisplay(fontSize: 18, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 12),
                      TextField(
                        controller: _searchController,
                        onChanged: (_) => setState(() {}),
                        decoration: InputDecoration(
                          hintText: 'Search by name, email or role...',
                          filled: true,
                          fillColor: const Color(0xFFF8FAFE),
                          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                        ),
                      ),
                      const SizedBox(height: 12),
                      Text('Total users: ${_docs.length}', style: GoogleFonts.montserrat(color: Colors.grey[700])),
                      const SizedBox(height: 12),
                      Row(
                        children: [
                          ElevatedButton(onPressed: () => _createUser(), child: const Text('Create User')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: _selected.isNotEmpty ? () => _deleteUsers(_selected.toList()) : null, child: const Text('Delete Selected')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: () => _sendMessageDialog(), child: const Text('Message')),
                        ],
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
      body: _loadingPage && _docs.isEmpty
          ? const Center(child: CircularProgressIndicator())
          : _docs.isEmpty
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.search_off, size: 64, color: Colors.grey[400]),
                      const SizedBox(height: 16),
                      Text(
                        _searchController.text.isEmpty ? 'No users found' : 'No users match "${_searchController.text}"',
                        style: GoogleFonts.montserrat(color: Colors.grey[600], fontSize: 16),
                      ),
                      if (_searchController.text.isNotEmpty) ...[
                        const SizedBox(height: 8),
                        TextButton(
                          onPressed: () {
                            _searchController.clear();
                            setState(() {});
                          },
                          child: Text('Clear search', style: GoogleFonts.montserrat(color: const Color(0xFFD62828))),
                        ),
                      ],
                    ],
                  ),
                )
              : Container(
                  color: Colors.white,
                  padding: const EdgeInsets.all(12),
                  child: SingleChildScrollView(
            child: Column(
              children: [
                Container(
                  padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 12),
                  color: Colors.grey.shade100,
                  child: Row(
                    children: [
                      SizedBox(width: 50, child: Text('No.', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                      Expanded(flex: 3, child: Text('User', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                      Expanded(flex: 1, child: Text('Role', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                      Expanded(flex: 1, child: Text('Created', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                      Expanded(flex: 1, child: Text('Last Login', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                      Expanded(flex: 1, child: Text('XP', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                      Expanded(flex: 1, child: Text('Rank', style: GoogleFonts.montserrat(fontWeight: FontWeight.w700, fontSize: 13))),
                    ],
                  ),
                ),
                const Divider(height: 1),
                ..._docs.asMap().entries.map((entry) {
                  final index = entry.key;
                  final doc = entry.value;
                  final data = doc.data() as Map<String, dynamic>;
                  final uid = doc.id;
                  final name = (data['displayName'] ?? '${data['firstName'] ?? ''} ${data['lastName'] ?? ''}').toString();
                  final email = (data['email'] ?? '').toString();
                  final role = (data['role'] ?? '').toString();
                  final created = (data['createdAt'] is Timestamp) ? (data['createdAt'] as Timestamp).toDate() : null;
                  final lastLogin = (data['lastLogin'] is Timestamp) ? (data['lastLogin'] as Timestamp).toDate() : null;
                  final xp = (data['badges'] != null) ? ((data['badges']['points'] ?? 0) as int) : (data['xp'] ?? 0);
                  final rank = (data['rankName'] ?? data['badges']?['level']?.toString() ?? '—').toString();

                  return InkWell(
                    onTap: () => _showUserDetailDialog(data),
                    child: Container(
                      padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 12),
                      decoration: BoxDecoration(border: Border(bottom: BorderSide(color: Colors.grey.shade200))),
                      child: Row(
                        children: [
                          SizedBox(
                            width: 50,
                            child: Text(
                              '${index + 1}',
                              style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, fontSize: 13, color: Colors.grey[700]),
                            ),
                          ),
                          Expanded(
                            flex: 3,
                            child: Row(children: [
                              CircleAvatar(
                                radius: 18,
                                backgroundColor: const Color(0xFFD62828).withValues(alpha: 0.1),
                                backgroundImage: (data['avatar'] as String?)?.isNotEmpty == true ? NetworkImage((data['avatar'] as String)) : null,
                                child: (data['avatar'] as String?) == null 
                                  ? Text(
                                      (name.isNotEmpty ? name[0] : '?').toUpperCase(), 
                                      style: GoogleFonts.montserrat(fontWeight: FontWeight.bold, color: const Color(0xFFD62828))
                                    ) 
                                  : null,
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      name.isNotEmpty ? name : email, 
                                      style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, fontSize: 13),
                                      overflow: TextOverflow.ellipsis,
                                    ),
                                    if (name.isNotEmpty)
                                      Text(
                                        email, 
                                        style: GoogleFonts.montserrat(fontSize: 11, color: Colors.grey[600]),
                                        overflow: TextOverflow.ellipsis,
                                      ),
                                  ],
                                ),
                              ),
                            ]),
                          ),
                          Expanded(
                            flex: 1,
                            child: Text(
                              role, 
                              style: GoogleFonts.montserrat()
                            )
                          ),
                          Expanded(
                            flex: 1,
                            child: Text(
                              created != null ? created.toLocal().toString().split('.')[0] : '—', 
                              style: GoogleFonts.montserrat(fontSize: 12)
                            )
                          ),
                          Expanded(
                            flex: 1,
                            child: Text(
                              lastLogin != null ? lastLogin.toLocal().toString().split('.')[0] : '—', 
                              style: GoogleFonts.montserrat(fontSize: 12)
                            )
                          ),
                          Expanded(
                            flex: 1,
                            child: Text(
                              xp.toString(), 
                              style: GoogleFonts.montserrat(fontWeight: FontWeight.w600, color: const Color(0xFFD62828))
                            )
                          ),
                          Expanded(
                            flex: 1,
                            child: Container(
                              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                              decoration: BoxDecoration(
                                color: rank != '—' ? const Color(0xFFD62828).withValues(alpha: 0.1) : Colors.grey.withValues(alpha: 0.1),
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: Text(
                                rank, 
                                style: GoogleFonts.montserrat(
                                  fontSize: 12,
                                  fontWeight: FontWeight.w600,
                                  color: rank != '—' ? const Color(0xFFD62828) : Colors.grey[700],
                                )
                              ),
                            )
                          ),
                        ],
                      ),
                    ),
                  );
                }).toList(),
                const Divider(height: 1),
                Padding(
                  padding: const EdgeInsets.symmetric(vertical: 8),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      TextButton(onPressed: _pageStack.isEmpty ? null : _prevPage, child: const Text('Prev')),
                      const SizedBox(width: 16),
                      TextButton(onPressed: _hasMore ? () => _fetchPage() : null, child: const Text('Next')),
                      if (_loadingPage) ...[const SizedBox(width: 16), const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2))],
                    ],
                  ),
                ),
              ],
            ),
          ),
    );
  }

  void _showUserDetailDialog(Map<String, dynamic> userData) {
    final uid = userData['uid'] ?? '';
    final avatar = userData['avatar'] as String?;
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        insetPadding: const EdgeInsets.symmetric(horizontal: 40, vertical: 24),
        child: ConstrainedBox(
          constraints: BoxConstraints(
            maxWidth: 600,
            maxHeight: MediaQuery.of(context).size.height * 0.8,
          ),
          child: Column(
            children: [
              Container(
                padding: const EdgeInsets.all(20),
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Color(0xFFD62828), Color(0xFFB71C1C)],
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                  ),
                  borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
                ),
                child: Row(
                  children: [
                    CircleAvatar(
                      radius: 32,
                      backgroundColor: Colors.white,
                      backgroundImage: avatar?.isNotEmpty == true ? NetworkImage(avatar!) : null,
                      child: avatar == null
                          ? Text(
                              ((userData['displayName'] ?? userData['firstName'] ?? '?') as String)[0].toUpperCase(), 
                              style: GoogleFonts.montserrat(fontSize: 20, color: const Color(0xFFD62828), fontWeight: FontWeight.bold)
                            )
                          : null,
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            userData['displayName'] ?? userData['firstName'] ?? '-', 
                            style: GoogleFonts.playfairDisplay(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white)
                          ),
                          const SizedBox(height: 4),
                          Text(
                            userData['email'] ?? '-',
                            style: GoogleFonts.montserrat(fontSize: 13, color: Colors.white.withValues(alpha: 0.9)),
                          ),
                        ],
                      ),
                    ),
                    IconButton(
                      icon: const Icon(Icons.close, color: Colors.white),
                      onPressed: () => Navigator.of(context).pop(),
                    ),
                  ],
                ),
              ),
              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Expanded(
                            child: _buildUserMetricCard(
                              'Role',
                              (userData['role'] ?? 'student').toString(),
                              Colors.blue,
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: _buildUserMetricCard(
                              'XP',
                              (userData['badges']?['points'] ?? userData['xp'] ?? 0).toString(),
                              const Color(0xFFD62828),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 12),
                      Row(
                        children: [
                          Expanded(
                            child: _buildUserMetricCard(
                              'Created',
                              userData['createdAt'] is Timestamp ? (userData['createdAt'] as Timestamp).toDate().toLocal().toString().split('.')[0] : '-',
                              Colors.green,
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: _buildUserMetricCard(
                              'Last Login',
                              userData['lastLogin'] is Timestamp ? (userData['lastLogin'] as Timestamp).toDate().toLocal().toString().split('.')[0] : '-',
                              Colors.orange,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 20),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.end,
                        children: [
                          TextButton(onPressed: () => _sendMessageToUsers([uid]), child: const Text('Send Message')),
                          const SizedBox(width: 8),
                          ElevatedButton(onPressed: () => _deleteUsers([uid]), style: ElevatedButton.styleFrom(backgroundColor: Colors.red), child: const Text('Delete User')),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildUserMetricCard(String label, String value, Color color) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: color.withValues(alpha: 0.3)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            label,
            style: GoogleFonts.montserrat(
              fontSize: 12,
              color: Colors.grey[700],
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            value,
            style: GoogleFonts.montserrat(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: color,
            ),
          ),
        ],
      ),
    );
  }
}